---
title: "PMCMC for agent-based SIS model"
author:  Seungha Um
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{PMCMC for agent-based SIS model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  editor_options: 
  chunk_output_type: console
---

# Introduction 

This vignette demonstrates how to implement PMCMC for agent-base SIS model using the `agentSIS` package. The small MCMC iterations and particles are used to reduce computation time; in practice, larger values (say, 20000 MCMC iterations and 300 particles) should be used. 

First, we load the requisite packages:

```{r, eval = TRUE, include=TRUE}
## Load library
library(tidyverse) # Load the tidyverse, mainly for ggplot
library(kableExtra) # For fancy tables
library(agentSIS) # Our package
library(zeallot) 
options(knitr.table.format = 'markdown')
```

# Setup

The following code creates a function to simulate data from the model.

```{r, eval = TRUE, include=TRUE}
set.seed(2022)
N <- 30;
steps <- 30;
X <- matrix(nrow = 2, ncol = N);
X[1,] <- 1;
X[2,] <- rnorm(N);

b_lam0 <- -1; b_lam1 <- 2; 
b_gam0 <- -1; b_gam1 <- -1;
Lambda <- fun_rate(b_lam0, b_lam1);
Gamma <- fun_rate(b_gam0, b_gam1);
Alpha <- rep(0.1, N)
Rho <- 0.8

## simulate observations
true_config <- list(N = N, alpha0 = Alpha, lambda = Lambda,
                    gamma = Gamma, rho = Rho)


sis_simulate <- function (days, true_config) {
  agent_states <- matrix(NA, nrow = true_config$N, ncol = 1 + days)
  agent_states[,1] <- (runif(N) < true_config$alpha0)
  for (d in c(2:(days + 1))) {
    alpha_t <- rep(NA, N)
    alpha_t <- sis_get_alpha(agent_states[, d - 1], true_config)
    agent_states[, d] <- (runif(N) < alpha_t)
  }
  y <- apply(agent_states, 2, function(xx) rbinom(n = 1, size = sum(xx), 
                                                  prob = true_config$rho))
  return(list(agent_states = agent_states, y = y))
}
```

We then create a dataset
```{r, eval = TRUE, include=TRUE}
complete_data <- sis_simulate(days = steps, true_config = true_config);
y <- complete_data$y;
## reject the process if observations are zero
y
```

Next, we create an object containing the hyperparameters for the model using the `Hypers` function. This function uses default hyperparameters unless specific hyperparameters are provided by the user; see `?Hypers` for more details.

```{r, eval = TRUE, include=TRUE}
hypers <- Hypers()
```

The function `Opts` produces a list of the parameters for running the Markov
chain for agent-based SIS model. For illustration we use only 250 burn-in and save iterations; the defaults are 5000 for each. `Opts` can also be used to control some features of the chain, such as step_size for MHRW and the number of particles; see `?Opts` for more details.

```{r, eval = TRUE, include=TRUE}
opt <- Opt(num_burn = 100, num_save = 100)
```

# Implementing PMCMC for agent-based model 

For PMCMC, there are PHHM (MH scheme) and Particle Gibbs (Gibbs sampling scheme). To improve the performance of Particle Gibbs (PG), we can add ancestor sampling step. Our package can implement PMMH, PG and PG with ancestor sampling. 

The functions create hyperparameters and options by defalts if not provided. We fit the simulate data by running

```{r, eval = TRUE, include=TRUE}
fit_PMMH <- PMMH_SIS(X, y, opt = opt)
fit_PG <- PG_SIS(X, y, opt = opt)
fit_PG_AS <- PG_AS_SIS(X, y, opt = opt)
```

We can compare three methods in terms of the estimated infection counts over time.

```{r, eval = TRUE, include=TRUE}
est_mat <- data.frame(time = rep(c(0:steps), 4), 
                      est = c(y, fit_PMMH$obs_counts_mean, fit_PG$obs_counts_mean,
                              fit_PG_AS$obs_counts_mean), 
                      grp = rep(c("observation","PMMH", "PG", "PGAS"), 
                                each=length(fit_PG$obs_counts_mean)))

ggplot(est_mat) + 
  geom_line(aes(x = time, y = est, color = grp, linetype = grp)) + theme_bw() +
  scale_color_manual(values=c("#999999", "#E69F00", "#117733", "#CC6677")) + 
  scale_linetype_manual(values=c("dashed","solid","solid","solid")) + 
  theme(legend.title=element_blank(),legend.position="bottom")

```

Parameter estimation with 95\% CI from PMMH

```{r, eval = TRUE, include=TRUE}
table_PMMH <- rbind(post_mean = colMeans(fit_PMMH$param_mat),
apply(fit_PMMH$param_mat, 2, function(x) quantile(x, c(0.025, 0.975))))
colnames(table_PMMH) <- c("alpha0", "alpha1", "lambda0", "lambda1","gamma0","gamma1","rho")
kable(table_PMMH)
```

Parameter estimation with 95\% CI from PG
```{r, eval = TRUE, include=TRUE}
table_PG <- rbind(post_mean = colMeans(fit_PG$param_mat),
apply(fit_PG$param_mat, 2, function(x) quantile(x, c(0.025, 0.975))))
colnames(table_PG) <- c("alpha0", "alpha1", "lambda0", "lambda1","gamma0","gamma1","rho")
kable(table_PG)
```

Parameter estimation with 95\% CI from PG with ancestor sampling
```{r, eval = TRUE, include=TRUE}
table_PG_AS <- rbind(post_mean = colMeans(fit_PG_AS$param_mat),
apply(fit_PG_AS$param_mat, 2, function(x) quantile(x, c(0.025, 0.975))))
colnames(table_PG_AS) <- c("alpha0", "alpha1", "lambda0", "lambda1","gamma0","gamma1","rho")
kable(table_PG_AS)
```





